# ============================================================
# Cloud-Powered ML Model Deployment Platform
# Test Script for /predict/<model> API
# Author: Akhi
# ============================================================

# --- CONFIGURATION ---
$baseUrl = "http://127.0.0.1:8000"
$modelName = "iris"
$auth = "admin:admin123"
Write-Host "`n=== Testing /predict/$modelName endpoint ===`n"

# --- Step 1: Verify active model ---
Write-Host ">>> Checking active models..."
curl "$baseUrl/models"
Write-Host "`nIf no active model is shown, activate one before proceeding.`n"
Start-Sleep -Seconds 3

# --- Step 2: Valid prediction ---
Write-Host ">>> [TC-P1] Valid Prediction Request"
@"
{
  "inputs": [
    {"sepal_length": 5.1, "sepal_width": 3.5, "petal_length": 1.4, "petal_width": 0.2}
  ]
}
"@ | Out-File -Encoding utf8 iris_valid.json

curl -X POST "$baseUrl/predict/$modelName" `
     -u $auth `
     -H "Content-Type: application/json" `
     -d "@iris_valid.json"
Write-Host "`n✅ Expected: 200 OK, prediction result ['setosa']`n"
Start-Sleep -Seconds 3


# --- Step 3: Missing authentication ---
Write-Host ">>> [TC-P2] Missing Authentication"
curl -X POST "$baseUrl/predict/$modelName" `
     -H "Content-Type: application/json" `
     -d "@iris_valid.json"
Write-Host "`n❌ Expected: 401 Unauthorized`n"
Start-Sleep -Seconds 3


# --- Step 4: Invalid model name ---
Write-Host ">>> [TC-P3] Invalid Model Name"
curl -X POST "$baseUrl/predict/invalidmodel" `
     -u $auth `
     -H "Content-Type: application/json" `
     -d "@iris_valid.json"
Write-Host "`n❌ Expected: 404 Model not found`n"
Start-Sleep -Seconds 3


# --- Step 5: Schema validation failure ---
Write-Host ">>> [TC-P5] Schema Validation Failure"
@"
{
  "inputs": [
    {"sepal_length": "wrong", "petal_width": 0.2}
  ]
}
"@ | Out-File -Encoding utf8 iris_invalid.json

curl -X POST "$baseUrl/predict/$modelName" `
     -u $auth `
     -H "Content-Type: application/json" `
     -d "@iris_invalid.json"
Write-Host "`n❌ Expected: 400 Schema validation failed`n"
Start-Sleep -Seconds 3


# --- Step 6: Metrics verification ---
Write-Host ">>> [TC-P6] Metrics Verification"
Write-Host "Open the following URL in your browser:`n$baseUrl/metrics"
Write-Host "✅ You should see mlserve_requests_total and mlserve_request_latency_seconds metrics."
Start-Sleep -Seconds 3


# --- Cleanup and summary ---
Write-Host "`nAll test cases executed."
Write-Host "If you saw correct responses for each, your /predict endpoint is fully functional!"
Write-Host "`n--- End of Test ---"
